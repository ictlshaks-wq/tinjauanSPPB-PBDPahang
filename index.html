<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>JPN PAHANG | Matriks Isu SPPB MOEIS</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Pemalam datalabels untuk paparan statistik pada graf -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Oswald:wght@700&family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
    
    body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f1f5f9; }
    .executive-card { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid #e2e8f0; }
    .executive-card:hover { transform: translateY(-8px); box-shadow: 0 30px 60px -12px rgba(50, 50, 93, 0.1), 0 18px 36px -18px rgba(0, 0, 0, 0.1); }
    .custom-scroll::-webkit-scrollbar { width: 5px; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    .glass-nav { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(16px); }
    .issue-item { border-left: 4px solid transparent; transition: all 0.2s; }
    .issue-item:hover { background: #f8fafc; border-left-color: #6366f1; transform: translateX(4px); }
    .severity-pill { font-size: 11px; padding: 4px 12px; border-radius: 99px; font-weight: 800; text-transform: uppercase; }
    .font-oswald { font-family: 'Oswald', sans-serif; }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-in { animation: fadeIn 0.5s ease forwards; }
  </style>
</head>

<body class="text-slate-900">
  <div id="loader" class="fixed top-0 left-0 h-1.5 bg-indigo-500 transition-all duration-700 z-50 w-0 shadow-[0_0_20px_rgba(99,102,241,0.8)]"></div>

  <div class="min-h-screen flex flex-col">
    <!-- Header Eksekutif -->
    <header class="glass-nav text-white sticky top-0 z-40 px-6 lg:px-10 py-6 border-b border-white/10">
      <div class="max-w-[1800px] mx-auto flex flex-col md:flex-row justify-between items-center gap-6">
        <div class="flex items-center gap-6">
          <div class="w-16 h-16 md:w-20 md:h-20 flex items-center justify-center bg-white/5 rounded-2xl p-2 shrink-0">
            <img src="https://raw.githubusercontent.com/ictlshaks-wq/LOGODGURU/main/LOGO%20JPN%20PUTIH.png" alt="Logo JPN" class="max-w-full max-h-full object-contain" onerror="this.src='https://via.placeholder.com/80?text=JPN'">
          </div>
          <div>
            <h1 class="text-xl md:text-3xl font-black tracking-tight uppercase leading-none text-white">JABATAN PENDIDIKAN NEGERI PAHANG</h1>
            <p id="meta" class="text-[10px] md:text-xs font-bold text-indigo-400 uppercase tracking-[0.2em] mt-2 flex items-center gap-3">
                <span id="statusDot" class="w-3 h-3 rounded-full bg-slate-500 shadow-lg"></span>
                <span id="statusText">Matriks Isu Pelaporan dan Perekodan Sistem SPPB MOEIS</span>
            </p>
            <p class="text-[8px] md:text-[9px] font-medium text-slate-500 uppercase tracking-[0.3em] mt-2 italic opacity-80">
                APLIKASI INI DIBANGUNKAN OLEH JK PBD NEGERI PAHANG 2026
            </p>
          </div>
        </div>

        <div class="flex items-center gap-6 md:gap-10">
          <div class="text-right hidden xl:block border-r border-white/10 pr-10">
            <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest leading-none">Status Data</p>
            <p id="timerText" class="text-sm font-bold text-indigo-400 mt-2 uppercase tracking-tighter">Sedia</p>
          </div>
          <button id="btnManualRefresh" class="bg-indigo-600 hover:bg-indigo-500 text-white px-6 md:px-8 py-3 md:py-4 rounded-2xl text-xs md:text-sm font-black transition-all shadow-xl active:scale-95 flex items-center gap-3 uppercase tracking-widest border border-indigo-400/20">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
            KEMAS KINI LIVE
          </button>
        </div>
      </div>
    </header>

    <main class="max-w-[1800px] mx-auto w-full p-6 md:p-12 space-y-12 md:space-y-16">
      <!-- Section 1: KPI & Aras Utama -->
      <section>
        <div class="flex flex-col md:flex-row items-start md:items-end justify-between mb-12 gap-6">
            <div class="max-w-4xl">
                <h2 class="text-3xl md:text-5xl font-black text-slate-900 tracking-tight uppercase font-oswald leading-tight">Tinjauan Isu Perekodan dan Pelaporan PBD dalam SPPB</h2>
                <p class="text-slate-500 text-sm md:text-lg font-bold uppercase tracking-widest mt-4">Analisis Berasaskan 570+ Respon (Status Semasa)</p>
            </div>
            <div class="bg-white px-8 md:px-12 py-6 md:py-8 rounded-[2rem] md:rounded-[3rem] border border-slate-200 shadow-sm text-center min-w-[200px] md:min-w-[280px]">
                <p class="text-[10px] md:text-xs font-black text-slate-400 uppercase tracking-widest">Total Aduan Diproses</p>
                <h3 id="kpiTotal" class="text-4xl md:text-6xl font-black text-indigo-600 mt-2 leading-none">0</h3>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 md:gap-12">
          <!-- JPN Card -->
          <div class="bg-white rounded-[2.5rem] md:rounded-[4rem] p-8 md:p-14 shadow-sm executive-card flex flex-col border-t-[12px] md:border-t-[16px] border-amber-500">
            <div class="flex items-center justify-between mb-10 md:mb-14">
              <span class="bg-amber-100 text-amber-700 px-6 py-2 rounded-full text-xs font-black uppercase tracking-widest">Aras: JPN</span>
              <div class="text-amber-600 font-black text-right">
                  <span id="countJPN" class="text-3xl md:text-4xl leading-none">0</span>
                  <span class="text-[10px] uppercase block opacity-60 text-slate-500 mt-1">Respon</span>
              </div>
            </div>
            <h3 class="text-[10px] font-black text-slate-400 uppercase mb-8 tracking-[0.2em] border-b-2 pb-3 border-slate-50">3 Masalah Utama (JPN)</h3>
            <div class="flex-1 space-y-6" id="listJPN">
                <div class="py-12 text-center animate-pulse text-slate-200 font-bold uppercase tracking-widest text-xs">Memuatkan...</div>
            </div>
          </div>

          <!-- PPD Card -->
          <div class="bg-white rounded-[2.5rem] md:rounded-[4rem] p-8 md:p-14 shadow-sm executive-card flex flex-col border-t-[12px] md:border-t-[16px] border-purple-600">
            <div class="flex items-center justify-between mb-10 md:mb-14">
              <span class="bg-purple-100 text-purple-700 px-6 py-2 rounded-full text-xs font-black uppercase tracking-widest">Aras: PPD</span>
              <div class="text-purple-600 font-black text-right">
                  <span id="countPPD" class="text-3xl md:text-4xl leading-none">0</span>
                  <span class="text-[10px] uppercase block opacity-60 text-slate-500 mt-1">Respon</span>
              </div>
            </div>
            <h3 class="text-[10px] font-black text-slate-400 uppercase mb-8 tracking-[0.2em] border-b-2 pb-3 border-slate-50">3 Masalah Utama (PPD)</h3>
            <div class="flex-1 space-y-6" id="listPPD">
                <div class="py-12 text-center animate-pulse text-slate-200 font-bold uppercase tracking-widest text-xs">Memuatkan...</div>
            </div>
          </div>

          <!-- SEKOLAH Card -->
          <div class="bg-slate-900 rounded-[2.5rem] md:rounded-[4rem] p-8 md:p-14 shadow-2xl shadow-slate-300 executive-card flex flex-col text-white border-t-[12px] md:border-t-[16px] border-indigo-500">
            <div class="flex items-center justify-between mb-10 md:mb-14">
              <span class="bg-white/10 text-indigo-300 px-6 py-2 rounded-full text-xs font-black uppercase tracking-widest border border-white/5">Aras: SEKOLAH</span>
              <div class="text-white font-black text-right">
                  <span id="countGuru" class="text-3xl md:text-4xl leading-none">0</span>
                  <span class="text-[10px] uppercase block text-slate-500 font-bold mt-1">Respon</span>
              </div>
            </div>
            <h3 class="text-[10px] font-black text-indigo-300 uppercase mb-8 tracking-[0.2em] border-b-2 border-white/5 pb-3">5 Masalah Utama (Sekolah)</h3>
            <div class="flex-1 space-y-6 custom-scroll overflow-y-auto max-h-[500px] pr-4" id="listGuru">
                <div class="py-12 text-center animate-pulse text-slate-600 font-bold uppercase tracking-widest text-xs">Memuatkan...</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Section 2: Graf & Explorer -->
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-10 md:gap-14">
        <!-- Sidebar Filters -->
        <aside class="lg:col-span-1 space-y-8 md:space-y-10">
          <div class="bg-white rounded-[2.5rem] md:rounded-[3rem] p-8 md:p-12 border border-slate-200 shadow-sm">
            <h4 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-8 flex items-center justify-between">
                Carian & Penapis
                <button id="btnResetAll" class="text-indigo-600 font-bold text-[10px] uppercase hover:underline">Reset</button>
            </h4>
            <div class="space-y-8">
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase mb-4 block tracking-widest">Pilih Aras</label>
                    <div class="flex flex-col gap-3" id="levelFilterContainer">
                        <button class="level-filter-btn text-left p-4 rounded-xl bg-slate-50 text-xs font-bold text-slate-600 border-2 border-transparent hover:border-indigo-200 transition-all flex justify-between items-center shadow-sm" data-level="JPN">Negeri (JPN)</button>
                        <button class="level-filter-btn text-left p-4 rounded-xl bg-slate-50 text-xs font-bold text-slate-600 border-2 border-transparent hover:border-indigo-200 transition-all flex justify-between items-center shadow-sm" data-level="PPD">Daerah (PPD)</button>
                        <button class="level-filter-btn text-left p-4 rounded-xl bg-slate-50 text-xs font-bold text-slate-600 border-2 border-transparent hover:border-indigo-200 transition-all flex justify-between items-center shadow-sm" data-level="Guru">Sekolah (Guru)</button>
                    </div>
                </div>
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase mb-4 block tracking-widest">Cari Teks Isu</label>
                    <input id="q" type="text" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-6 py-4 text-xs font-bold outline-none focus:ring-4 focus:ring-indigo-500/10 focus:bg-white transition-all shadow-sm" placeholder="cth: server, ralat, markah..." />
                </div>
            </div>
          </div>

          <div class="bg-indigo-700 rounded-[2.5rem] md:rounded-[3rem] p-8 md:p-12 text-white shadow-xl shadow-indigo-200 relative overflow-hidden">
            <h4 class="text-indigo-200 text-[10px] font-black uppercase tracking-widest mb-6">Executive Insight</h4>
            <div id="aiSummary" class="text-base md:text-lg leading-relaxed font-bold italic z-10 relative">Memproses data...</div>
            <div class="absolute -bottom-10 -right-10 w-32 h-32 bg-white/5 rounded-full"></div>
          </div>
        </aside>

        <!-- Main Content (Graph & Table) -->
        <div class="lg:col-span-3 space-y-10 md:space-y-12">
            <!-- Graf Bar Statistik -->
            <div class="bg-white rounded-[2.5rem] md:rounded-[4rem] p-8 md:p-14 border border-slate-200 shadow-sm relative overflow-hidden">
                <div class="flex flex-col md:flex-row md:items-center justify-between mb-10 md:mb-12 gap-4">
                    <h4 class="text-xl md:text-2xl font-black text-slate-800 tracking-tight">Analisis Kekerapan: Jumlah & Peratusan</h4>
                    <span class="text-[10px] font-black bg-slate-100 text-slate-400 px-5 py-2 rounded-full uppercase tracking-widest border border-slate-200 w-fit">Statistik Isu Keseluruhan</span>
                </div>
                <div class="h-[400px] md:h-[500px] w-full">
                    <canvas id="temaChart"></canvas>
                </div>
            </div>

            <!-- Table Logs -->
            <div class="bg-white rounded-[2.5rem] md:rounded-[4rem] border border-slate-200 overflow-hidden shadow-sm">
                <div class="px-8 md:px-12 py-8 md:py-10 border-b-2 border-slate-50 bg-slate-50/40 flex justify-between items-center">
                    <h4 class="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em]">Log Laporan Aduan Terkini</h4>
                    <span id="rowCount" class="text-[10px] font-bold text-white bg-slate-900 px-5 py-2 rounded-full shadow-lg">0 Rekod Diproses</span>
                </div>
                <div class="overflow-x-auto custom-scroll max-h-[600px] md:max-h-[700px]">
                    <table class="w-full text-left text-base">
                        <thead class="sticky top-0 bg-white shadow-sm z-10">
                            <tr class="text-slate-400 text-[10px] font-black uppercase tracking-widest border-b border-slate-100">
                                <th class="px-8 md:px-12 py-6">Aras</th>
                                <th class="px-6 md:px-8 py-6">Institusi / Wilayah</th>
                                <th class="px-6 md:px-8 py-6">Kategori Isu</th>
                                <th class="px-6 md:px-8 py-6 w-1/3">Butiran Aduan</th>
                                <th class="px-8 md:px-12 py-6 text-right">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="tbody" class="divide-y divide-slate-50 text-slate-600 font-medium">
                            <tr><td colspan="5" class="px-12 py-40 text-center text-slate-300 font-black uppercase text-xs tracking-[0.3em] animate-pulse italic">Menjalankan Analisis...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
      </div>

      <!-- Section 3: Demografi -->
      <section class="bg-slate-900 rounded-[2.5rem] md:rounded-[4rem] p-10 md:p-16 shadow-2xl text-white">
        <div class="mb-10 border-b border-white/10 pb-8 flex flex-col md:flex-row items-start md:items-center justify-between gap-6">
            <div>
                <h3 class="text-2xl md:text-3xl font-black uppercase font-oswald tracking-tight">Profil Responden & Demografi</h3>
                <p class="text-slate-400 text-sm md:text-base font-bold mt-2">Pecahan profil berdasarkan pangkalan data aduan JPN Pahang.</p>
            </div>
            <div class="bg-white/5 border border-white/10 px-6 py-4 rounded-3xl">
                <span class="text-[10px] font-black text-indigo-400 uppercase tracking-widest block mb-1">Status Pangkalan Data</span>
                <span class="text-base md:text-lg font-black text-white italic">LIVE DATA SYNC</span>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 md:gap-12">
            <div class="bg-white/5 border border-white/10 rounded-[2rem] md:rounded-[3rem] p-8 md:p-10 executive-card">
                <div class="flex items-center gap-4 mb-8">
                    <div class="w-10 h-10 md:w-12 md:h-12 bg-indigo-600 rounded-2xl flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                    </div>
                    <h4 class="text-xs font-black uppercase tracking-widest text-slate-400">Jumlah Keseluruhan</h4>
                </div>
                <div class="flex items-baseline gap-2 mb-2">
                    <span id="demoTotal" class="text-5xl md:text-7xl font-black text-white leading-none">0</span>
                    <span class="text-sm md:text-lg font-bold text-slate-500 uppercase">Responden</span>
                </div>
            </div>

            <div class="bg-white/5 border border-white/10 rounded-[2rem] md:rounded-[3rem] p-8 md:p-10 executive-card flex flex-col">
                <div class="flex items-center gap-4 mb-8">
                    <div class="w-10 h-10 md:w-12 md:h-12 bg-amber-500 rounded-2xl flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                    </div>
                    <h4 class="text-xs font-black uppercase tracking-widest text-slate-400">Pecahan Peranan</h4>
                </div>
                <div id="roleStats" class="space-y-6 flex-1"></div>
            </div>

            <div class="bg-white/5 border border-white/10 rounded-[2rem] md:rounded-[3rem] p-8 md:p-10 executive-card flex flex-col">
                <div class="flex items-center gap-4 mb-8">
                    <div class="w-10 h-10 md:w-12 md:h-12 bg-purple-600 rounded-2xl flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>
                    </div>
                    <h4 class="text-xs font-black uppercase tracking-widest text-slate-400">Kategori Institusi</h4>
                </div>
                <div id="schoolStats" class="space-y-6 flex-1"></div>
            </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Toast & Popups -->
  <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-8 py-5 rounded-full shadow-2xl opacity-0 translate-y-20 pointer-events-none flex items-center gap-6 z-50 transition-all duration-500 border border-white/10">
    <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white shadow-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" /></svg></div>
    <span class="text-xs font-black uppercase tracking-widest">Aduan Berjaya Disalin</span>
  </div>

  <script>
    const DEFAULT_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQClpGROxWAevH16ZTDVKHWy93WIyXiuOGq0-2xKkjDmi4FspRGO4vbZNqHW1_7HnYFwFKZzI-j7wQE/pub?gid=68317720&single=true&output=csv"; 

    const THEME_RULES = [
      { level: 'JPN', theme: "Data Tak Tepat / Bertindih", re: /(mentah|duplicate|bertindih|bersihkan|tepat|duplikasi|tercicir)/i, color: '#f59e0b', bg: '#fffbeb', severity: 'Kritikal' },
      { level: 'PPD', theme: "Isu Murid / Guru Pindah", re: /(pertukaran|pindah|sekolah\s*lama|sekolah\s*baru|murid\s*pindah|guru\s*pindah|mobiliti)/i, color: '#a855f7', bg: '#faf5ff', severity: 'Sederhana' },
      { level: 'PPD', theme: "Masalah Login / Peranan", re: /(peranan|role|akses|sppb|pentadbir|manual|prosedur|akaun|IDM|idme|login|masuk)/i, color: '#7c3aed', bg: '#f5f3ff', severity: 'Rendah' },
      { level: 'Guru', theme: "Sistem Lambat / Hang", re: /(lambat|slow|hang|loading|timeout|down|lag|trafik|server|perlahan|pusing|pusing2|jem|pusing-pusing)/i, color: '#f43f5e', bg: '#fff1f2', severity: 'Kritikal' },
      { level: 'Guru', theme: "Data Hilang / Tak Simpan", re: /(hilang|ralat|error|tidak\s*simpan|save|kosong|terpadam|refresh|tidak\s*lekat|berulang)/i, color: '#6366f1', bg: '#eef2ff', severity: 'Kritikal' },
      { level: 'Guru', theme: "Kerja Berulang / Kerja Malam", re: /(beban|dua\s*kali|berulang|pengkeranian|singkat|malam|2\s*pagi|1\s*pagi|rehat|masa|terganggu|lewat\s*malam)/i, color: '#ec4899', bg: '#fdf2f8', severity: 'Kritikal' },
      { level: 'Umum', theme: "Tiada Masalah / OK", re: /(tiada\s*masalah|tiada\s*isu|mudah|lancar|tiada|ok|baik|sppb)/i, color: '#10b981', bg: '#f0fdf4', severity: 'Stabil' },
    ];

    const COL_MAP = {
      ts: ['timestamp', 'masa', 'tarikh'],
      role: ['peranan', 'jawatan'],
      ppd: ['ppd', 'daerah'],
      sekolah: ['sekolah', 'nama sekolah'],
      jenis_sekolah: ['jenis sekolah', 'jenis', 'tahap sekolah'],
      isu: ['isu utama', 'perkara', 'masalah', 'problem'],
      kesan: ['kesan', 'impak']
    };

    const $ = (id) => document.getElementById(id);
    const state = { rawData: [], filteredData: [], chart: null, activeCols: {}, timer: null, nextRefreshIn: 60, selectedLevel: "" };

    // Register Plugin Datalabels
    Chart.register(ChartDataLabels);

    function parseCSVRobust(text) {
      const rows = [];
      let row = [];
      let currentField = '';
      let inQuotes = false;
      const cleanText = text.replace(/^\ufeff/, "").trim();
      for (let i = 0; i < cleanText.length; i++) {
        const char = cleanText[i];
        const nextChar = cleanText[i + 1];
        if (char === '"') {
          if (inQuotes && nextChar === '"') { currentField += '"'; i++; }
          else inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          row.push(currentField.trim()); currentField = '';
        } else if ((char === '\n' || char === '\r') && !inQuotes) {
          if (char === '\r' && nextChar === '\n') i++;
          row.push(currentField.trim());
          if (row.length > 0) rows.push(row);
          row = []; currentField = '';
        } else currentField += char;
      }
      if (currentField || row.length > 0) { row.push(currentField.trim()); rows.push(row); }
      return rows;
    }

    function resolveHeaders(headers) {
      const mapping = {};
      const norm = headers.map(h => (h || "").toString().toLowerCase().trim());
      Object.keys(COL_MAP).forEach(key => {
        const keywords = COL_MAP[key];
        let idx = norm.findIndex(h => keywords.some(k => h === k));
        if (idx === -1) idx = norm.findIndex(h => keywords.some(k => h.includes(k)));
        mapping[key] = idx !== -1 ? headers[idx] : null;
      });
      return mapping;
    }

    function pickTheme(r) {
      const isu = (r[state.activeCols.isu] || "").toLowerCase();
      const kesan = (r[state.activeCols.kesan] || "").toLowerCase();
      const role = (r[state.activeCols.role] || "").toLowerCase();
      const combined = `${isu} ${kesan}`;
      let level = 'Guru';
      if(role.includes('jpn') || role.includes('negeri')) level = 'JPN';
      else if(role.includes('ppd') || role.includes('daerah')) level = 'PPD';
      for (const rule of THEME_RULES) if (rule.re.test(combined)) return {...rule, detectedLevel: level};
      return { theme: "Isu Lain-lain", color: '#94a3b8', level: 'Umum', detectedLevel: level, severity: 'Sederhana' };
    }

    function updateStrategicUI() {
      const d = state.filteredData;
      const r = state.rawData;
      const c = state.activeCols;
      
      const levels = ['JPN', 'PPD', 'Guru'];
      const stats = { JPN: [], PPD: [], Guru: [] };

      d.forEach(item => { if(stats[item.__theme.detectedLevel]) stats[item.__theme.detectedLevel].push(item); });

      levels.forEach(lvl => {
        if ($(`count${lvl}`)) $(`count${lvl}`).textContent = stats[lvl].length;
        const counts = {};
        stats[lvl].forEach(item => {
            if (item.__theme.theme !== "Tiada Masalah / OK") {
                counts[item.__theme.theme] = (counts[item.__theme.theme] || 0) + 1;
            }
        });

        const listEl = $(`list${lvl}`);
        if(listEl) {
            listEl.innerHTML = "";
            const topUnique = Object.keys(counts).sort((a,b) => counts[b] - counts[a]).slice(0, (lvl === 'Guru' ? 5 : 3));
            if(topUnique.length === 0) {
                listEl.innerHTML = `<div class="p-12 text-center text-slate-200 font-black uppercase text-[10px] tracking-[0.2em] border-2 border-dashed border-slate-100 rounded-3xl">Tiada Rekod</div>`;
            } else {
                topUnique.forEach((themeName, idx) => {
                    const themeObj = THEME_RULES.find(t => t.theme === themeName) || { color: '#94a3b8', severity: 'Sederhana' };
                    const count = counts[themeName];
                    const pct = stats[lvl].length > 0 ? Math.round((count / stats[lvl].length) * 100) : 0;
                    const div = document.createElement('div');
                    div.className = `issue-item p-6 rounded-2xl bg-white border border-slate-100 animate-in`;
                    div.style.borderLeftColor = themeObj.color;
                    // Mengeluarkan line-clamp-2 untuk memaparkan teks penuh
                    div.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <span class="severity-pill" style="color: ${themeObj.color}; background: ${themeObj.color}15">${themeObj.severity}</span>
                            <span class="text-[9px] font-black text-slate-300 italic">RANK #${idx+1}</span>
                        </div>
                        <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">${themeName}</p>
                        <p class="text-sm font-black text-slate-800 leading-tight whitespace-normal break-words">${stats[lvl].find(i => i.__theme.theme === themeName)[c.isu]}</p>
                        <div class="mt-4 flex justify-between items-center text-[10px] font-bold">
                            <span class="text-slate-400 uppercase">Kekerapan: <span class="text-indigo-600 font-black">${pct}%</span></span>
                            <span class="text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded">${count} Aduan</span>
                        </div>
                    `;
                    listEl.appendChild(div);
                });
            }
        }
      });

      // UPDATE CHART (JUMLAH & PERATUS)
      if (state.chart) state.chart.destroy();
      const globalCounts = {};
      d.forEach(item => { if (item.__theme.theme !== "Tiada Masalah / OK") globalCounts[item.__theme.theme] = (globalCounts[item.__theme.theme] || 0) + 1; });
      const totalFiltered = Object.values(globalCounts).reduce((a, b) => a + b, 0);
      const labels = THEME_RULES.map(t => t.theme).filter(l => l !== "Tiada Masalah / OK");
      
      const ctx = $("temaChart");
      if(ctx) {
        state.chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{ 
                    data: labels.map(l => globalCounts[l] || 0), 
                    backgroundColor: THEME_RULES.filter(t => t.theme !== "Tiada Masalah / OK").map(t => t.color), 
                    borderRadius: 12, 
                    barThickness: 32 
                }]
            },
            options: { 
                indexAxis: 'y', 
                responsive: true, 
                maintainAspectRatio: false, 
                plugins: { 
                    legend: { display: false },
                    datalabels: {
                        anchor: 'end',
                        align: 'right',
                        offset: 10,
                        color: '#475569',
                        font: { weight: '800', size: 12 },
                        formatter: (val) => {
                            if (totalFiltered === 0 || val === 0) return "";
                            const p = ((val / totalFiltered) * 100).toFixed(1);
                            return `${val} (${p}%)`;
                        }
                    }
                },
                layout: { padding: { right: 90 } },
                scales: { 
                    x: { display: false }, 
                    y: { grid: { display: false }, ticks: { font: { weight: 'bold', size: 11 }, color: '#64748b' } } 
                } 
            }
        });
      }

      if($("aiSummary")) {
          const topOverall = labels.sort((a,b) => (globalCounts[b]||0) - (globalCounts[a]||0))[0];
          $("aiSummary").innerHTML = topOverall ? `Parameter aduan paling tinggi di Pahang melibatkan <b>${topOverall}</b>.` : "Tahap kestabilan sistem optimum.";
      }

      if($("demoTotal")) $("demoTotal").textContent = r.length;

      // Update Role & School Stats
      const updateDemStats = (containerId, key, color) => {
          const counts = {};
          r.forEach(item => { const v = (item[c[key]] || "Lain-lain").trim(); counts[v] = (counts[v] || 0) + 1; });
          const el = $(containerId);
          if (el) {
              el.innerHTML = Object.keys(counts).sort((a,b) => counts[b] - counts[a]).map(v => {
                  const p = Math.round((counts[v] / r.length) * 100);
                  return `<div><div class="flex justify-between items-center mb-1"><span class="text-[10px] font-black uppercase text-slate-400">${v}</span><span class="text-xs font-black text-white">${counts[v]}</span></div>
                          <div class="h-2 w-full bg-white/5 rounded-full overflow-hidden"><div class="h-full rounded-full transition-all duration-1000" style="width: ${p}%; background: ${color}"></div></div></div>`;
              }).join("");
          }
      };
      updateDemStats("roleStats", "role", "#6366f1");
      updateDemStats("schoolStats", "jenis_sekolah", "#a855f7");

      // Update Table
      const tbody = $("tbody");
      if(tbody) {
          tbody.innerHTML = "";
          if($("rowCount")) $("rowCount").textContent = `${d.length} Rekod`;
          d.slice(0, 40).forEach(item => {
              const tr = document.createElement("tr");
              tr.className = "hover:bg-indigo-50/50 transition-all border-b border-slate-50 group cursor-pointer";
              // Mengeluarkan line-clamp-3 untuk memaparkan teks penuh dalam jadual
              tr.innerHTML = `<td class="px-8 md:px-12 py-6"><span class="text-[10px] font-black uppercase px-3 py-1.5 rounded-lg bg-slate-900 text-white">${item.__theme.detectedLevel}</span></td>
                              <td class="px-6 md:px-8 py-6 font-black text-slate-800 text-base break-words">${item[c.sekolah] || item[c.ppd] || "ARAS PUSAT"}</td>
                              <td class="px-6 md:px-8 py-6 text-[10px] font-black uppercase" style="color: ${item.__theme.color}">${item.__theme.theme}</td>
                              <td class="px-6 md:px-8 py-6 text-slate-500 font-medium italic text-xs leading-relaxed break-words">${item[c.isu]}</td>
                              <td class="px-8 md:px-12 py-6 text-right"><button class="bg-indigo-600 text-white px-4 py-2 rounded-xl text-[10px] font-black opacity-0 group-hover:opacity-100 shadow-xl transition-all">SALIN</button></td>`;
              tr.onclick = () => {
                  const content = `[ADUAN SPPB] ${item.__theme.theme}\nARAS: ${item.__theme.detectedLevel}\nSEKOLAH: ${item[c.sekolah] || "N/A"}\nISU: ${item[c.isu]}`;
                  const t = document.createElement("textarea"); t.value = content; document.body.appendChild(t); t.select(); document.execCommand("copy"); document.body.removeChild(t);
                  $("toast").classList.remove("opacity-0", "translate-y-20"); setTimeout(() => $("toast").classList.add("opacity-0", "translate-y-20"), 2000);
              };
              tbody.appendChild(tr);
          });
      }
    }

    async function loadData() {
      const loader = $("loader");
      if(loader) loader.style.width = "40%";
      if($("statusText")) $("statusText").textContent = "Mengambil data Pahang...";
      try {
        const res = await fetch(DEFAULT_CSV_URL + "&t=" + Date.now());
        const text = await res.text();
        const rows = parseCSVRobust(text);
        if (rows.length < 2) return;
        state.activeCols = resolveHeaders(rows[0]);
        state.rawData = rows.slice(1).map(v => { const o = {}; rows[0].forEach((h, i) => o[h] = v[i] || ""); return o; });
        if(loader) loader.style.width = "100%";
        if($("kpiTotal")) $("kpiTotal").textContent = state.rawData.length;
        if($("statusText")) $("statusText").textContent = `LIVE: ${state.rawData.length} RESPON AKTIF`;
        if($("statusDot")) $("statusDot").className = "w-3 h-3 rounded-full bg-green-500 shadow-[0_0_15px_#22c55e]";
        applyFilters();
        state.nextRefreshIn = 60;
        setTimeout(() => { if(loader) loader.style.width = "0%"; }, 600);
      } catch (e) {
        if($("statusText")) $("statusText").textContent = "RALAT: Hubungan Terputus";
        if($("statusDot")) $("statusDot").className = "w-3 h-3 rounded-full bg-red-500";
      }
    }

    function applyFilters() {
      const qVal = $("q").value.trim().toLowerCase();
      const c = state.activeCols;
      state.filteredData = state.rawData.filter(item => {
        const matchLvl = !state.selectedLevel || pickTheme(item).detectedLevel === state.selectedLevel;
        const textSearch = `${item[c.isu]} ${item[c.sekolah]} ${item[c.ppd]}`.toLowerCase();
        return matchLvl && textSearch.includes(qVal);
      }).map(item => ({ ...item, __theme: pickTheme(item) }));
      updateStrategicUI();
    }

    setInterval(() => {
        state.nextRefreshIn--;
        if(state.nextRefreshIn <= 0) { loadData(); state.nextRefreshIn = 60; }
        if($("timerText")) $("timerText").textContent = `KEMAS KINI DALAM ${state.nextRefreshIn}S`;
    }, 1000);

    window.onload = () => {
        loadData();
        if($("btnManualRefresh")) $("btnManualRefresh").onclick = loadData;
        if($("btnResetAll")) $("btnResetAll").onclick = () => { 
            $("q").value = ""; state.selectedLevel = ""; 
            document.querySelectorAll('.level-filter-btn').forEach(b => b.classList.remove('border-indigo-500', 'bg-indigo-50'));
            applyFilters(); 
        };
        if($("q")) $("q").oninput = applyFilters;
        document.querySelectorAll('.level-filter-btn').forEach(btn => {
            btn.onclick = () => { 
                document.querySelectorAll('.level-filter-btn').forEach(b => b.classList.remove('border-indigo-500', 'bg-indigo-50'));
                btn.classList.add('border-indigo-500', 'bg-indigo-50');
                state.selectedLevel = btn.dataset.level; applyFilters(); 
            };
        });
    };
  </script>
</body>
</html>
